# Design Document - Scope Reduction to Linux and Android

## Overview

This design outlines the systematic approach to reducing Overdrive's scope from a multi-platform application to a focused Linux desktop and Android mobile solution. The design prioritizes safety, maintains functionality, and ensures a clean, maintainable codebase.

## Architecture

### Current State Analysis

```mermaid\ngraph TB\n    subgraph \"Current Applications\"\n        A[Desktop - Tauri] \n        B[Mobile - React Native]\n        C[Web - Vite/React]\n        D[Landing - Next.js]\n        E[Server - Axum]\n        F[Storybook - Storybook]\n    end\n    \n    subgraph \"Shared Packages\"\n        G[packages/client]\n        H[packages/ui]\n        I[packages/config]\n        J[packages/assets]\n        K[interface/]\n    end\n    \n    subgraph \"Core Rust\"\n        L[core/]\n        M[crates/*]\n    end\n    \n    A --> G\n    A --> H\n    A --> K\n    B --> G\n    C --> G\n    C --> K\n    D --> H\n    \n    G --> I\n    H --> I\n    K --> G\n    K --> H\n    \n    A --> L\n    E --> L\n```\n\n### Target State Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Target Applications\"\n        A[Desktop - Tauri Linux]\n        A2[Future: Mobile - Tauri Android]\n    end\n    \n    subgraph \"Retained Packages\"\n        G[packages/client]\n        H[packages/ui]\n        I[packages/config]\n        J[packages/assets]\n        K[interface/]\n    end\n    \n    subgraph \"Core Rust - Linux Focus\"\n        L[core/ - Linux optimized]\n        M[crates/* - Essential only]\n    end\n    \n    A --> G\n    A --> H\n    A --> K\n    A2 -.-> G\n    A2 -.-> H\n    \n    G --> I\n    H --> I\n    K --> G\n    K --> H\n    \n    A --> L\n    A2 -.-> L\n    \n    style A2 fill:#e1f5fe\n    style A fill:#c8e6c9\n```\n\n## Components and Interfaces\n\n### 1. Application Removal Strategy\n\n#### Safe Removal Order\n1. **Storybook** (lowest risk - development tool only)\n2. **Landing Page** (low risk - no shared dependencies)\n3. **Web App** (medium risk - shares interface components)\n4. **Server App** (medium risk - shares core Rust code)\n5. **Mobile App** (highest risk - most complex dependencies)\n\n#### Dependency Validation Process\n```rust\n// Pseudo-code for validation\nstruct RemovalValidator {\n    retained_apps: Vec<App>,\n    shared_packages: Vec<Package>,\n}\n\nimpl RemovalValidator {\n    fn validate_removal(&self, app: &App) -> Result<(), RemovalError> {\n        // Check if any retained apps depend on this app\n        for retained in &self.retained_apps {\n            if retained.depends_on(app) {\n                return Err(RemovalError::HasDependents);\n            }\n        }\n        \n        // Check if removing this app breaks shared packages\n        for package in &self.shared_packages {\n            if package.only_used_by(app) {\n                return Err(RemovalError::OrphansPackage);\n            }\n        }\n        \n        Ok(())\n    }\n}\n```\n\n### 2. Platform-Specific Code Removal\n\n#### Conditional Compilation Cleanup\n```rust\n// Before: Multiple platform support\n#[cfg(target_os = \"windows\")]\nuse crate::volume::windows::WindowsVolume;\n#[cfg(target_os = \"macos\")]\nuse crate::volume::macos::MacOsVolume;\n#[cfg(target_os = \"linux\")]\nuse crate::volume::linux::LinuxVolume;\n\n// After: Linux-focused\nuse crate::volume::linux::LinuxVolume;\n\n// Keep Android preparation\n#[cfg(target_os = \"android\")]\nuse crate::volume::android::AndroidVolume;\n```\n\n#### File System Module Restructure\n```rust\n// core/src/volume/mod.rs - Before\npub mod linux;\n#[cfg(target_os = \"macos\")]\npub mod macos;\n#[cfg(target_os = \"windows\")]\npub mod windows;\n\n// core/src/volume/mod.rs - After\npub mod linux;\n#[cfg(target_os = \"android\")]\npub mod android;\n\npub use linux::LinuxVolume as Volume;\n#[cfg(target_os = \"android\")]\npub use android::AndroidVolume as Volume;\n```\n\n### 3. Dependency Management\n\n#### Cargo Workspace Cleanup\n```toml\n# Cargo.toml - Before\n[workspace]\nmembers = [\n    \"apps/desktop/crates/*\",\n    \"apps/desktop/src-tauri\",\n    \"apps/mobile/modules/sd-core/android/crate\",  # Remove\n    \"apps/mobile/modules/sd-core/core\",           # Remove\n    \"apps/mobile/modules/sd-core/ios/crate\",      # Remove\n    \"apps/server\",                                # Remove\n    \"core\",\n    \"core/crates/*\",\n    \"crates/*\"\n]\n\n# Cargo.toml - After\n[workspace]\nmembers = [\n    \"apps/desktop/crates/*\",\n    \"apps/desktop/src-tauri\",\n    \"core\",\n    \"core/crates/*\",\n    \"crates/*\"\n]\n```\n\n#### Platform Dependencies Removal\n```toml\n# Remove Windows dependencies\n[target.'cfg(windows)'.workspace.dependencies]\nwindows = { version = \"0.58\", features = [...] }  # DELETE\n\n# Remove macOS dependencies  \n[target.'cfg(target_os = \"macos\")'.dependencies]\ncocoa = \"0.25\"     # DELETE\nobjc = \"0.2\"       # DELETE\n\n# Remove iOS dependencies\n[target.'cfg(target_os = \"ios\")'.workspace.dependencies]\nswift-rs = \"1.0.7\"  # DELETE\n\n# Keep Android dependencies for future\n[target.'cfg(target_os = \"android\")'.workspace.dependencies]\njni = \"0.21\"  # KEEP\n```\n\n### 4. Build System Optimization\n\n#### Package.json Workspace Update\n```json\n{\n  \"scripts\": {\n    // Remove these scripts\n    \"landing-web\": \"...\",     // DELETE\n    \"web\": \"...\",             // DELETE  \n    \"mobile\": \"...\",          // DELETE\n    \"landing\": \"...\",         // DELETE\n    \"storybook\": \"...\",       // DELETE\n    \"dev:web\": \"...\",         // DELETE\n    \n    // Keep these scripts\n    \"desktop\": \"pnpm --filter @sd/desktop --\",\n    \"tauri\": \"pnpm desktop tauri\",\n    \"dev:desktop\": \"pnpm run --filter @sd/desktop tauri dev\",\n    \"bootstrap:desktop\": \"cargo clean && ./scripts/setup.sh && pnpm i && pnpm prep && pnpm tauri dev\"\n  }\n}\n```\n\n#### Tauri Configuration Update\n```json\n{\n  \"bundle\": {\n    \"targets\": [\n      \"appimage\",    // Keep - Linux\n      \"deb\"          // Keep - Linux\n      // Remove: \"dmg\", \"msi\", \"nsis\"\n    ]\n  },\n  \"plugins\": {\n    // Remove platform-specific plugins\n  }\n}\n```\n\n## Data Models\n\n### Removal Tracking\n```typescript\ninterface RemovalPlan {\n  applications: {\n    name: string;\n    path: string;\n    dependencies: string[];\n    riskLevel: 'low' | 'medium' | 'high';\n    removalOrder: number;\n  }[];\n  \n  platformCode: {\n    files: string[];\n    conditionalBlocks: string[];\n    dependencies: string[];\n  };\n  \n  buildTargets: {\n    cargo: string[];\n    tauri: string[];\n    npm: string[];\n  };\n}\n```\n\n### Validation Results\n```typescript\ninterface ValidationResult {\n  buildSuccess: boolean;\n  testsPassing: boolean;\n  performanceMetrics: {\n    buildTime: number;\n    binarySize: number;\n    dependencyCount: number;\n  };\n  regressions: string[];\n}\n```\n\n## Error Handling\n\n### Removal Safety Checks\n1. **Pre-removal Validation**:\n   - Verify no critical dependencies\n   - Create backup of current state\n   - Run full test suite\n\n2. **During Removal**:\n   - Incremental removal with validation\n   - Immediate rollback on critical errors\n   - Continuous integration testing\n\n3. **Post-removal Validation**:\n   - Full build verification\n   - Functionality testing\n   - Performance benchmarking\n\n### Error Recovery Strategy\n```bash\n#!/bin/bash\n# Rollback script for failed removals\nrollback_removal() {\n    local backup_branch=\"$1\"\n    echo \"Rolling back to $backup_branch\"\n    git checkout \"$backup_branch\"\n    pnpm install\n    cargo build\n    echo \"Rollback complete\"\n}\n```\n\n## Testing Strategy\n\n### Automated Testing Pipeline\n```yaml\n# .github/workflows/scope-reduction.yml\nname: Scope Reduction Validation\non: [push, pull_request]\n\njobs:\n  validate-removal:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v3\n      \n      - name: Setup Environment\n        run: ./scripts/setup-overdrive.sh\n      \n      - name: Build Desktop App\n        run: pnpm desktop tauri build\n      \n      - name: Run Tests\n        run: |\n          cargo test\n          pnpm typecheck\n      \n      - name: Performance Benchmark\n        run: ./scripts/benchmark.sh\n      \n      - name: Validate Functionality\n        run: ./scripts/validate-functionality.sh\n```\n\n### Manual Testing Checklist\n- [ ] Desktop app builds successfully\n- [ ] Desktop app launches without errors\n- [ ] File operations work correctly\n- [ ] Settings and preferences preserved\n- [ ] Database migrations work\n- [ ] Performance meets benchmarks\n\n## Performance Considerations\n\n### Expected Improvements\n1. **Build Time**: 30-50% reduction\n   - Fewer Rust crates to compile\n   - Fewer Node.js packages to process\n   - Simplified dependency resolution\n\n2. **Binary Size**: 20-40% reduction\n   - Removed platform-specific code\n   - Fewer bundled dependencies\n   - Optimized for single platform\n\n3. **Development Experience**: \n   - Faster hot reloads\n   - Simpler debugging\n   - Reduced context switching\n\n### Benchmarking Strategy\n```rust\n// Performance benchmarking\n#[cfg(test)]\nmod benchmarks {\n    use criterion::{black_box, criterion_group, criterion_main, Criterion};\n    \n    fn bench_file_operations(c: &mut Criterion) {\n        c.bench_function(\"file_scan\", |b| {\n            b.iter(|| {\n                // Benchmark file scanning performance\n                black_box(scan_directory(\"/tmp/test\"))\n            })\n        });\n    }\n    \n    criterion_group!(benches, bench_file_operations);\n    criterion_main!(benches);\n}\n```\n\n## Security Considerations\n\n### Safe Removal Process\n1. **Data Preservation**: Ensure no user data is lost\n2. **Configuration Migration**: Preserve user settings\n3. **Backup Strategy**: Create recovery points\n4. **Validation**: Comprehensive testing before finalization\n\n### Linux-Specific Security\n1. **File Permissions**: Proper handling of Linux file permissions\n2. **Sandboxing**: Maintain Tauri security model\n3. **System Integration**: Safe interaction with Linux desktop\n\nThis design provides a comprehensive, safe approach to reducing Overdrive's scope while maintaining all essential functionality and improving performance and maintainability."
